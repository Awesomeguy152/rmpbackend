openapi: 3.0.3
info: { title: Kotlin JWT Backend, version: 1.0.0 }
paths:
  /api/auth/register:
    post:
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
                role: { type: string, enum: [ADMIN, USER] }
                adminSecret:
                  type: string
                  nullable: true
                  description: Required when `role` is `ADMIN`.
      responses: { "201": { description: Created } }
  /api/auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
      responses: { "200": { description: OK } }
  /api/chat/conversations/direct:
    post:
      summary: Create or reuse direct conversation
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDirectConversationRequest"
      responses:
        "200":
          description: Conversation info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
  /api/chat/conversations:
    get:
      summary: List conversations for current user
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: limit,
            in: query,
            schema: { type: integer, minimum: 1, maximum: 100 },
            description: Page size,
          }
        - {
            name: offset,
            in: query,
            schema: { type: integer, minimum: 0 },
            description: Offset for pagination,
          }
      responses:
        "200":
          description: Conversation summaries
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ConversationSummary" }
        "401": { description: Unauthorized }
  /api/chat/conversations/group:
    post:
      summary: Create group conversation
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              { $ref: "#/components/schemas/CreateGroupConversationRequest" }
      responses:
        "201":
          description: Created conversation
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Conversation" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
  /api/chat/conversations/{id}/topic:
    patch:
      summary: Update group conversation topic
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              { $ref: "#/components/schemas/UpdateConversationTopicRequest" }
      responses:
        "200":
          description: Updated conversation
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Conversation" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Conversation missing }
  /api/chat/conversations/{id}/members:
    post:
      summary: Add members to group conversation
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ModifyMembersRequest" }
      responses:
        "200":
          description: Updated member list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ConversationMember" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Conversation missing }
  /api/chat/conversations/{id}/messages:
    post:
      summary: Send message to conversation
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendMessageRequest"
      responses:
        "201":
          description: Created message
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Conversation missing }
    get:
      summary: List messages in conversation
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
        - {
            name: limit,
            in: query,
            schema: { type: integer, minimum: 1, maximum: 100 },
            description: Page size,
          }
        - {
            name: offset,
            in: query,
            schema: { type: integer, minimum: 0 },
            description: Offset for pagination,
          }
        - {
            name: only,
            in: query,
            schema: { $ref: "#/components/schemas/MessageTagFilter" },
            description: Filter by tag (meetings/answers/important),
          }
        - {
            name: q,
            in: query,
            schema: { type: string },
            description: Keyword search,
          }
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Message" }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Conversation missing }
  /api/chat/conversations/{id}/members/{memberId}:
    delete:
      summary: Remove member from group conversation
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
        - {
            name: memberId,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      responses:
        "200":
          description: Updated member list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ConversationMember" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Conversation missing }
  /api/chat/conversations/{id}/read:
    post:
      summary: Mark conversation as read
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/MarkReadRequest" }
      responses:
        "202": { description: Mark scheduled }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "404": { description: Conversation missing }
  /api/chat/messages:
    get:
      summary: Search messages across conversations
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: limit,
            in: query,
            schema: { type: integer, minimum: 1, maximum: 100 },
            description: Page size,
          }
        - {
            name: offset,
            in: query,
            schema: { type: integer, minimum: 0 },
            description: Offset for pagination,
          }
        - {
            name: only,
            in: query,
            schema: { $ref: "#/components/schemas/MessageTagFilter" },
            description: Filter by tag (meetings/answers/important),
          }
        - {
            name: q,
            in: query,
            schema: { type: string },
            description: Keyword search,
          }
      responses:
        "200":
          description: List of messages available to the user
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Message" }
        "401": { description: Unauthorized }
  /api/chat/messages/{id}/tag:
    post:
      summary: Update message tag
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagMessageRequest"
      responses:
        "200":
          description: Updated message
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Message not found }
  /api/chat/messages/{id}:
    patch:
      summary: Edit message
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/EditMessageRequest" }
      responses:
        "200":
          description: Updated message
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "400": { description: Invalid payload }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Message not found }
    delete:
      summary: Soft delete message
      security: [{ bearerAuth: [] }]
      parameters:
        - {
            name: id,
            in: path,
            required: true,
            schema: { type: string, format: uuid },
          }
      responses:
        "200":
          description: Updated message state
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Message not found }
  /api/ai/summary:
    post:
      summary: Summarize conversation (stub)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AiConversationRequest" }
      responses:
        "200":
          description: Summary payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AiSummary" }
        "401": { description: Unauthorized }
  /api/ai/next-action:
    post:
      summary: Suggest next actions (stub)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AiConversationRequest" }
      responses:
        "200":
          description: Suggestions payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AiNextAction" }
        "401": { description: Unauthorized }
  /api/me:
    get:
      {
        security: [{ bearerAuth: [] }],
        responses: { "200": { description: OK } },
      }
  /api/admin/users:
    get:
      {
        security: [{ bearerAuth: [] }],
        responses: { "200": { description: OK } },
      }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    CreateDirectConversationRequest:
      type: object
      required: [memberId]
      properties:
        memberId: { type: string, format: uuid }
        topic: { type: string, nullable: true }
    SendMessageRequest:
      type: object
      required: [body]
      properties:
        body: { type: string }
        attachments:
          type: array
          items: { $ref: "#/components/schemas/MessageAttachmentPayload" }
    TagMessageRequest:
      type: object
      required: [tag]
      properties:
        tag: { $ref: "#/components/schemas/MessageTag" }
    MessageTag:
      type: string
      enum: [NONE, ANSWER, MEETING, IMPORTANT]
    MessageAttachment:
      type: object
      properties:
        id: { type: string, format: uuid }
        fileName: { type: string }
        contentType: { type: string }
        dataBase64: { type: string, description: Base64-encoded payload }
    MessageTagFilter:
      type: string
      enum: [meetings, answers, important]
    Conversation:
      type: object
      properties:
        id: { type: string, format: uuid }
        type: { type: string, enum: [DIRECT, GROUP] }
        topic: { type: string, nullable: true }
        directKey: { type: string, nullable: true }
        createdBy: { type: string, format: uuid }
        createdAt: { type: string, format: date-time }
    MessageAttachmentPayload:
      type: object
      required: [fileName, contentType, dataBase64]
      properties:
        fileName: { type: string }
        contentType: { type: string }
        dataBase64: { type: string }
    CreateGroupConversationRequest:
      type: object
      required: [memberIds]
      properties:
        topic: { type: string, nullable: true }
        memberIds:
          type: array
          minItems: 1
          items: { type: string, format: uuid }
    UpdateConversationTopicRequest:
      type: object
      properties:
        topic: { type: string, nullable: true }
    ModifyMembersRequest:
      type: object
      required: [memberIds]
      properties:
        memberIds:
          type: array
          minItems: 1
          items: { type: string, format: uuid }
    EditMessageRequest:
      type: object
      properties:
        body: { type: string, nullable: true }
        attachments:
          type: array
          nullable: true
          items: { $ref: "#/components/schemas/MessageAttachmentPayload" }
    MarkReadRequest:
      type: object
      properties:
        messageId: { type: string, format: uuid, nullable: true }
    Message:
      type: object
      properties:
        id: { type: string, format: uuid }
        conversationId: { type: string, format: uuid }
        senderId: { type: string, format: uuid }
        body: { type: string }
        tag: { $ref: "#/components/schemas/MessageTag" }
        createdAt: { type: string, format: date-time }
        editedAt: { type: string, format: date-time, nullable: true }
        deletedAt: { type: string, format: date-time, nullable: true }
        attachments:
          type: array
          items: { $ref: "#/components/schemas/MessageAttachment" }
    AiConversationRequest:
      type: object
      required: [conversationId]
      properties:
        conversationId: { type: string, format: uuid }
    ConversationMember:
      type: object
      properties:
        userId: { type: string, format: uuid }
        joinedAt: { type: string, format: date-time }
    ConversationSummary:
      type: object
      properties:
        id: { type: string, format: uuid }
        type: { type: string, enum: [DIRECT, GROUP] }
        topic: { type: string, nullable: true }
        createdBy: { type: string, format: uuid }
        createdAt: { type: string, format: date-time }
        members:
          type: array
          items: { $ref: "#/components/schemas/ConversationMember" }
        lastMessage:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/Message"
        unreadCount: { type: integer, format: int64 }
    AiSummary:
      type: object
      properties:
        conversationId: { type: string, format: uuid }
        summary: { type: string }
        generatedAt: { type: string, format: date-time }
    AiNextAction:
      type: object
      properties:
        conversationId: { type: string, format: uuid }
        suggestions:
          type: array
          items: { type: string }
        generatedAt: { type: string, format: date-time }
